<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Changelog tÃ©cnico â€” Abyssus Bot</title>
  <link rel="icon" type="image/png" href="img/favicon.png">
  <link href="css/style.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', 'Roboto', sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      padding: 0 20px;
    }
    summary {
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      margin: 20px 0 10px;
    }
    details {
      margin-bottom: 30px;
      border-left: 2px solid #3498db;
      padding-left: 15px;
    }
    code {
      background-color: #1e1e1e;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .updated {
      animation: flash 0.6s ease;
    }
    @keyframes flash {
      0% { background-color: #3498db; color: #fff; }
      100% { background-color: inherit; color: inherit; }
    }
  </style>
</head>

<body>
  <h1>ğŸ“˜ Changelog tÃ©cnico â€” Abyssus Bot</h1>

  <details open>
    <summary>ğŸ› ï¸ Cambios en el bot</summary>
    <p><strong>Fecha:</strong> 2025-09-14</p>
    <p><strong>ğŸ“¦ /reputation:</strong> Embed agregado, boost detectado, cooldown 10 min</p>
    <p><strong>ğŸ“Š /userinfo:</strong> SecciÃ³n reputaciÃ³n integrada, lectura desde <code>Usuario.json</code></p>
    <p><strong>ğŸ”§ Internos:</strong> OptimizaciÃ³n de lectura, blindaje adicional</p>
  </details>

  <details>
    <summary>ğŸ§© Cambios en el dashboard</summary>
    <p><strong>ğŸ“ Visual:</strong> TipografÃ­a limpia, bloques plegables, navegaciÃ³n interna</p>
    <p><strong>ğŸ“¦ SEO:</strong> JSON-LD activo, validaciÃ³n estructural</p>
    <p><strong>ğŸ›¡ï¸ Blindaje:</strong> Herencia exacta, sin estilos genÃ©ricos</p>
  </details>

  <details>
    <summary>ğŸ“˜ DocumentaciÃ³n tÃ©cnica â€” /modlogs</summary>
    <p><strong>DescripciÃ³n:</strong> Historial de moderaciÃ³n con filtros y exportaciÃ³n</p>
    <p><strong>Commit:</strong> <code>f2d1a8c</code> Â· 2025-09-15 Â· Mr.Abyssus</p>
  </details>

  <details open>
    <summary>ğŸ“¡ Estado del sistema â€” Abyssus Bot</summary>
    <p><strong>ğŸ“¶ Latencia:</strong> <span id="latency">Cargando...</span></p>
    <p><strong>â±ï¸ Uptime:</strong> <span id="uptime">Cargando...</span></p>
    <p><strong>ğŸ•’ Ãšltima actualizaciÃ³n:</strong> <span id="timestamp">Cargando...</span></p>
    <p><strong>ğŸŒ Servidores:</strong> <span id="servers">Cargando...</span></p>
    <p><strong>ğŸ‘¥ Usuarios:</strong> <span id="users">Cargando...</span></p>
    <p><strong>ğŸ“ˆ Comandos usados:</strong> <span id="commandsUsed">Cargando...</span></p>
    <p><em id="lastUpdate">Actualizado hace 0 segundos</em></p>
    <button onclick="updateStatus()">ğŸ”„ Actualizar estado</button>
  </details>

  <footer>
    <p>2021â€“2025 Abyssus. Todos los derechos reservados.</p>
    <a href="http://abyssusbot.mired.ovh:3000/status" style="color:#3498db;">Ver estado completo</a>
  </footer>
require('dotenv').config();
const express = require('express');
const fs = require('fs');
const path = require('path');

module.exports = function (client) {
  const app = express();
  const port = 3000;

  app.use(express.json());

  app.post('/api/changelog', (req, res) => {
    const auth = req.headers['x-auth-token'];
    if (auth !== process.env.TOKEN_ADMIN) return res.status(403).send('âŒ No autorizado');

    const { titulo, cambios } = req.body;
    if (!titulo || !cambios) return res.status(400).send('âŒ Datos incompletos');

    const logPath = path.join(__dirname, 'logs', 'eventos.log');
    const timestamp = new Date().toLocaleString();
    const entrada = `ğŸ”§ ${titulo} (${timestamp})\n${cambios.split('\n').map(c => `â€¢ ${c.trim()}`).join('\n')}\n\n`;

    try {
      fs.appendFileSync(logPath, entrada, 'utf8');
      res.send('âœ… Changelog registrado');
    } catch (err) {
      console.error('âŒ Error al registrar changelog:', err.message);
      res.status(500).send('Error interno');
    }
  });

  app.get('/status', (req, res) => {
    const statusHTML = `<!DOCTYPE html>
<html>
  <head>
    <title>Status de Abyssus</title>
    <style>
      body {
        background-color: #0f0f0f;
        color: #f0f0f0;
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .card {
        background-color: #1e1e1e;
        padding: 2em;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,255,255,0.2);
        text-align: center;
        width: 90%;
        max-width: 400px;
        margin-top: 2em;
      }
      h1 {
        color: #00ffff;
        margin-bottom: 0.5em;
      }
      p {
        font-size: 1.1em;
        margin: 0.5em 0;
      }
      .emoji {
        font-size: 2em;
      }
      button {
        margin-top: 1em;
        padding: 0.5em 1em;
        background-color: #00ffff;
        border: none;
        border-radius: 6px;
        color: #0f0f0f;
        font-weight: bold;
        cursor: pointer;
      }
      .updated {
        animation: pulse 0.6s ease-in-out;
      }
      @keyframes pulse {
        0% { background-color: rgba(0,255,255,0.1); }
        50% { background-color: rgba(0,255,255,0.3); }
        100% { background-color: rgba(0,255,255,0.1); }
      }
      #modalLog {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }
      #modalLogContent {
        background-color: #1e1e1e;
        padding: 2em;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        color: #f0f0f0;
        box-shadow: 0 0 20px rgba(0,255,255,0.3);
        overflow-y: auto;
        max-height: 80vh;
      }
      #logContenido {
        white-space: pre-wrap;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="emoji">ğŸ¤–</div>
      <h1>Abyssus estÃ¡ <span id="status">...</span></h1>
      <p><strong>ğŸ“¶ Latencia:</strong> <span id="latency">...</span></p>
      <p><strong>â±ï¸ Uptime:</strong> <span id="uptime">...</span></p>
      <p><strong>ğŸ•’ Ãšltima actualizaciÃ³n:</strong> <span id="timestamp">...</span></p>
      <p><strong>ğŸŒ Servidores:</strong> <span id="servers">...</span></p>
      <p><strong>ğŸ‘¥ Usuarios:</strong> <span id="users">...</span></p>
      <p><strong>ğŸ“ˆ Comandos usados:</strong> <span id="commandsUsed">...</span></p>
      <p><em id="lastUpdate">Actualizado hace 0 segundos</em></p>
      <button onclick="updateStatus()">ğŸ”„ Actualizar</button>
      <button onclick="abrirLog()">ğŸ“œ Ver log</button>
    </div>

    <div id="modalLog">
      <div id="modalLogContent">
        <h2 style="color:#00ffff;">ğŸ“œ Registro de eventos</h2>
        <pre id="logContenido">Cargando...</pre>
        <button onclick="cerrarLog()">Cerrar</button>
      </div>
    </div>

    <script>
      const TOKEN_ADMIN = 'ghostnet-abyssus-2025';

      let secondsSinceUpdate = 0;
      let updateTimer;

      function animateUpdate(id) {
        const el = document.getElementById(id);
        el.classList.add('updated');
        setTimeout(() => el.classList.remove('updated'), 600);
      }

      async function updateStatus() {
        const res = await fetch('/api/status');
        const data = await res.json();

        document.getElementById('status').textContent = data.online ? 'âœ… Online' : 'âš ï¸ Sin conexiÃ³n';
        document.getElementById('status').style.color = data.online ? '#00ff88' : '#ff4444';
        animateUpdate('status');

        document.getElementById('latency').textContent = data.latency + ' ms';
        animateUpdate('latency');

        document.getElementById('uptime').textContent = formatUptime(data.uptime);
        animateUpdate('uptime');

        document.getElementById('timestamp').textContent = data.timestamp;
        animateUpdate('timestamp');

        document.getElementById('servers').textContent = data.servers;
        animateUpdate('servers');

        document.getElementById('users').textContent = data.users;
        animateUpdate('users');

        document.getElementById('commandsUsed').textContent = data.commandsUsed.toLocaleString();
        animateUpdate('commandsUsed');

        secondsSinceUpdate = 0;
        document.getElementById('lastUpdate').textContent = 'Actualizado hace 0 segundos';

        if (!updateTimer) {
          updateTimer = setInterval(() => {
            secondsSinceUpdate++;
            document.getElementById('lastUpdate').textContent = \`Actualizado hace \${secondsSinceUpdate} segundos\`;
          }, 1000);
        }
      }

      function formatUptime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return \`\${h}h \${m}m \${s}s\`;
      }

      async function abrirLog() {
        const res = await fetch('/api/log');
        const data = await res.text();
        document.getElementById('logContenido').textContent = data || 'Sin eventos recientes.';
        document.getElementById('modalLog').style.display = 'flex';
      }

      function cerrarLog() {
        document.getElementById('modalLog').style.display = 'none';
      }

      async function enviarChangelog() {
        const titulo = prompt('TÃ­tulo del changelog:');
        const cambios = prompt('Lista de cambios (separados por salto de lÃ­nea):');

        if (!titulo || !cambios) return alert('âŒ Datos incompletos');

        const res = await fetch('/api/changelog', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': TOKEN_ADMIN
          },
          body: JSON.stringify({ titulo, cambios })
        });

        const msg = await res.text();
        alert(msg);
        updateStatus();
      }

              function mostrarBotonChangelog() {
        const clave = prompt('ğŸ” Ingresa tu clave para registrar cambios:');
        if (clave !== TOKEN_ADMIN) return;

        const btn = document.createElement('button');
        btn.textContent = 'ğŸ§© Registrar cambios';
        btn.onclick = enviarChangelog;
        btn.style.marginTop = '1em';
        document.querySelector('.card').appendChild(btn);
      }

      window.onload = () => {
        updateStatus();
        mostrarBotonChangelog();
      };
    </script>
  </body>
</html>`;
    res.send(statusHTML);
  });

  app.listen(port, () => {
    console.log(`ğŸŒ Dashboard activo en http://localhost:${port}/status`);
  });
};
